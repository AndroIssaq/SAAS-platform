===============================================================================
  Ø¥ØµÙ„Ø§Ø­: Foreign Key Constraint Error - affiliate_id
===============================================================================

Date: November 3, 2025, 8:44 AM
Error: insert or update on table "contracts" violates foreign key constraint 
       "contracts_affiliate_id_fkey"

===============================================================================
  Ø§Ù„Ù…Ø´ÙƒÙ„Ø©
===============================================================================

Ø¹Ù†Ø¯ Ù…Ø­Ø§ÙˆÙ„Ø© Ø¥Ù†Ø´Ø§Ø¡ Ø¹Ù‚Ø¯ Ù…Ù† Ø­Ø³Ø§Ø¨ Ø§Ù„Ø´Ø±ÙŠÙƒ:
  âŒ Error: Foreign key constraint violation
  âŒ Ø§Ù„Ø³Ø¨Ø¨: affiliate_id ØºÙŠØ± Ù…ÙˆØ¬ÙˆØ¯ ÙÙŠ Ø¬Ø¯ÙˆÙ„ affiliates

Ø§Ù„ØªØ³Ù„Ø³Ù„:
  1. Ø§Ù„Ø´Ø±ÙŠÙƒ ÙŠØ³Ø¬Ù„ Ø¯Ø®ÙˆÙ„
  2. ÙŠØ°Ù‡Ø¨ Ù„ØµÙØ­Ø© Ø¥Ù†Ø´Ø§Ø¡ Ø¹Ù‚Ø¯: /affiliate/contracts/new
  3. Ø§Ù„ÙƒÙˆØ¯ ÙŠØ­ØµÙ„ Ø¹Ù„Ù‰ affiliate.id Ù…Ù† Ø¬Ø¯ÙˆÙ„ affiliates
  4. ÙŠØ­Ø§ÙˆÙ„ Ø¥Ù†Ø´Ø§Ø¡ Ø¹Ù‚Ø¯ Ø¨Ù‡Ø°Ø§ Ø§Ù„Ù€ affiliate_id
  5. Ù‚Ø§Ø¹Ø¯Ø© Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª ØªØ±ÙØ¶ Ù„Ø£Ù† Ø§Ù„Ù€ ID ØºÙŠØ± Ù…ÙˆØ¬ÙˆØ¯!

===============================================================================
  Ø§Ù„Ø³Ø¨Ø¨ Ø§Ù„Ø¬Ø°Ø±ÙŠ
===============================================================================

ÙˆØ§Ø­Ø¯ Ù…Ù† Ù‡Ø°Ù‡ Ø§Ù„Ø£Ø³Ø¨Ø§Ø¨:

Ø§Ù„Ø³Ø¨Ø¨ 1: Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù… ØºÙŠØ± Ù…Ø³Ø¬Ù„ ÙƒÙ€ affiliate
â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  - Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù… Ù…ÙˆØ¬ÙˆØ¯ ÙÙŠ Ø¬Ø¯ÙˆÙ„ auth.users
  - Ù„ÙƒÙ† ØºÙŠØ± Ù…ÙˆØ¬ÙˆØ¯ ÙÙŠ Ø¬Ø¯ÙˆÙ„ public.affiliates
  - Ø§Ù„ÙƒÙˆØ¯ ÙŠØ­Ø§ÙˆÙ„ Ø§Ù„Ø­ØµÙˆÙ„ Ø¹Ù„Ù‰ affiliate.id Ù„ÙƒÙ† Ù„Ø§ ÙŠØ¬Ø¯ Ø´ÙŠØ¡
  - ÙŠØ±Ø³Ù„ NULL Ø£Ùˆ ID Ø®Ø§Ø·Ø¦

Ø§Ù„Ø³Ø¨Ø¨ 2: Ø§Ù„Ù€ affiliate_id Ø§Ù„Ù…ÙØ±Ø³Ù„ Ø®Ø§Ø·Ø¦
â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  - affiliate Ù…ÙˆØ¬ÙˆØ¯ ÙÙŠ Ø§Ù„Ø¬Ø¯ÙˆÙ„
  - Ù„ÙƒÙ† Ø§Ù„Ù€ ID Ø§Ù„Ù…ÙØ±Ø³Ù„ Ù…Ø®ØªÙ„Ù
  - Ù…Ø«Ù„Ø§Ù‹: Ø§Ù„ÙƒÙˆØ¯ ÙŠØ±Ø³Ù„ user.id Ø¨Ø¯Ù„Ø§Ù‹ Ù…Ù† affiliate.id

Ø§Ù„Ø³Ø¨Ø¨ 3: Ù…Ø´ÙƒÙ„Ø© ÙÙŠ Ø§Ù„Ù€ constraint Ù†ÙØ³Ù‡
â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  - Ø§Ù„Ù€ constraint ÙŠØ´ÙŠØ± Ù„Ø¹Ù…ÙˆØ¯ Ø®Ø§Ø·Ø¦
  - Ø£Ùˆ Ø§Ù„Ø¬Ø¯ÙˆÙ„ Ø§Ù„Ù…Ø±Ø¬Ø¹ÙŠ Ø®Ø§Ø·Ø¦

===============================================================================
  Ø§Ù„ØªØ´Ø®ÙŠØµ - Ø®Ø·ÙˆØ© Ø¨Ø®Ø·ÙˆØ©
===============================================================================

Ø§Ù„Ø®Ø·ÙˆØ© 1: ØªØ­Ù‚Ù‚ Ù…Ù† ÙˆØ¬ÙˆØ¯ Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù… ÙÙŠ affiliates
â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€

ÙÙŠ Supabase SQL EditorØŒ Ø´ØºÙ‘Ù„:

  -- Ø§Ø³ØªØ¨Ø¯Ù„ USER_ID Ø¨Ø§Ù„Ù€ ID Ø§Ù„ÙØ¹Ù„ÙŠ Ù„Ù„Ù…Ø³ØªØ®Ø¯Ù…
  SELECT 
    a.id AS affiliate_id,
    a.user_id,
    a.name,
    a.email,
    a.status,
    u.email AS auth_email
  FROM affiliates a
  LEFT JOIN auth.users u ON a.user_id = u.id
  WHERE a.user_id = 'USER_ID_HERE';

Ø§Ù„Ù†ØªÙŠØ¬Ø© Ø§Ù„Ù…ØªÙˆÙ‚Ø¹Ø©:
  âœ“ ÙŠØ¸Ù‡Ø± Ø³Ø·Ø± ÙˆØ§Ø­Ø¯ Ù…Ø¹ affiliate_id
  âŒ Ù„Ø§ ÙŠØ¸Ù‡Ø± Ø´ÙŠØ¡ = Ø§Ù„Ù…Ø´ÙƒÙ„Ø© Ù‡Ù†Ø§!

â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€

Ø§Ù„Ø®Ø·ÙˆØ© 2: ØªØ­Ù‚Ù‚ Ù…Ù† Ø¬Ù…ÙŠØ¹ Ø§Ù„Ù€ affiliates
â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€

  SELECT 
    id,
    user_id,
    name,
    email,
    status,
    created_at
  FROM affiliates
  ORDER BY created_at DESC;

Ù‡Ù„ ÙŠØ¸Ù‡Ø± Ø§Ù„Ø´Ø±ÙŠÙƒ Ø§Ù„Ø°ÙŠ ØªØ­Ø§ÙˆÙ„ Ø§Ø³ØªØ®Ø¯Ø§Ù…Ù‡ØŸ
  âœ“ Ù†Ø¹Ù… = Ø§Ù„Ù…Ø´ÙƒÙ„Ø© ÙÙŠ Ø§Ù„ÙƒÙˆØ¯
  âŒ Ù„Ø§ = ÙŠØ¬Ø¨ Ø¥Ù†Ø´Ø§Ø¡ Ø³Ø¬Ù„ affiliate

â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€

Ø§Ù„Ø®Ø·ÙˆØ© 3: ØªØ­Ù‚Ù‚ Ù…Ù† Ø§Ù„ÙƒÙˆØ¯
â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€

Ø§ÙØªØ­ Browser Console (F12) Ø¹Ù†Ø¯ Ø¥Ù†Ø´Ø§Ø¡ Ø§Ù„Ø¹Ù‚Ø¯
Ø§Ø¨Ø­Ø« Ø¹Ù†:
  ğŸ” DEBUG - Saving to database:

ØªØ­Ù‚Ù‚ Ù…Ù†:
  {
    affiliate_id: "xxx-xxx-xxx"  â† Ù‡Ù„ Ù‡Ø°Ø§ Ø§Ù„Ù€ ID Ù…ÙˆØ¬ÙˆØ¯ ÙÙŠ affiliatesØŸ
  }

â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€

Ø§Ù„Ø®Ø·ÙˆØ© 4: ØªØ­Ù‚Ù‚ Ù…Ù† Ø§Ù„Ù€ constraint
â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€

  SELECT 
    tc.constraint_name, 
    kcu.column_name, 
    ccu.table_name AS foreign_table,
    ccu.column_name AS foreign_column
  FROM information_schema.table_constraints tc 
  JOIN information_schema.key_column_usage kcu
    ON tc.constraint_name = kcu.constraint_name
  JOIN information_schema.constraint_column_usage ccu
    ON ccu.constraint_name = tc.constraint_name
  WHERE tc.table_name='contracts'
    AND kcu.column_name = 'affiliate_id';

Ø§Ù„Ù†ØªÙŠØ¬Ø© Ø§Ù„Ù…ØªÙˆÙ‚Ø¹Ø©:
  constraint_name:  contracts_affiliate_id_fkey
  column_name:      affiliate_id
  foreign_table:    affiliates
  foreign_column:   id

===============================================================================
  Ø§Ù„Ø­Ù„ - Ø­Ø³Ø¨ Ø§Ù„Ø³Ø¨Ø¨
===============================================================================

Ø§Ù„Ø­Ù„ 1: Ø¥Ù†Ø´Ø§Ø¡ Ø³Ø¬Ù„ affiliate Ù„Ù„Ù…Ø³ØªØ®Ø¯Ù…
â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€

Ø¥Ø°Ø§ ÙƒØ§Ù† Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù… ØºÙŠØ± Ù…ÙˆØ¬ÙˆØ¯ ÙÙŠ Ø¬Ø¯ÙˆÙ„ affiliates:

  -- Ø§Ø­ØµÙ„ Ø¹Ù„Ù‰ user_id Ù…Ù† auth
  SELECT id, email FROM auth.users WHERE email = 'affiliate@example.com';

  -- Ø£Ù†Ø´Ø¦ Ø³Ø¬Ù„ affiliate
  INSERT INTO affiliates (
    user_id,
    name,
    email,
    phone,
    status,
    commission_rate
  ) VALUES (
    'USER_ID_FROM_ABOVE',
    'Ø§Ø³Ù… Ø§Ù„Ø´Ø±ÙŠÙƒ',
    'affiliate@example.com',
    '01234567890',
    'active',
    10.00
  );

  -- ØªØ­Ù‚Ù‚ Ù…Ù† Ø§Ù„Ø¥Ù†Ø´Ø§Ø¡
  SELECT id, name, email FROM affiliates WHERE user_id = 'USER_ID';

â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€

Ø§Ù„Ø­Ù„ 2: Ø¥ØµÙ„Ø§Ø­ Ø§Ù„Ù€ constraint
â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€

Ø¥Ø°Ø§ ÙƒØ§Ù† Ø§Ù„Ù€ constraint Ø¨Ù‡ Ù…Ø´ÙƒÙ„Ø©:

  -- Ø§Ø­Ø°Ù Ø§Ù„Ù€ constraint Ø§Ù„Ù‚Ø¯ÙŠÙ…
  ALTER TABLE contracts 
  DROP CONSTRAINT IF EXISTS contracts_affiliate_id_fkey;

  -- Ø£Ø¶Ù constraint Ø¬Ø¯ÙŠØ¯ ØµØ­ÙŠØ­
  ALTER TABLE contracts
  ADD CONSTRAINT contracts_affiliate_id_fkey 
  FOREIGN KEY (affiliate_id) 
  REFERENCES affiliates(id)
  ON DELETE SET NULL
  ON UPDATE CASCADE;

â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€

Ø§Ù„Ø­Ù„ 3: Ø¥ØµÙ„Ø§Ø­ Ø§Ù„ÙƒÙˆØ¯ (Ø¥Ø°Ø§ ÙƒØ§Ù† ÙŠØ±Ø³Ù„ ID Ø®Ø§Ø·Ø¦)
â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€

ØªØ­Ù‚Ù‚ Ù…Ù†:
  File: app/affiliate/contracts/new/page.tsx
  Line: 53

ÙŠØ¬Ø¨ Ø£Ù† ÙŠÙƒÙˆÙ†:
  affiliateId={affiliate.id}  â† ØµØ­ÙŠØ­
  
ÙˆÙ„ÙŠØ³:
  affiliateId={user.id}  â† Ø®Ø·Ø£!

â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€

Ø§Ù„Ø­Ù„ 4: Ø¬Ø¹Ù„ affiliate_id nullable
â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€

Ø¥Ø°Ø§ ÙƒÙ†Øª ØªØ±ÙŠØ¯ Ø¯Ø¹Ù… Ø¹Ù‚ÙˆØ¯ Ø¨Ø¯ÙˆÙ† affiliate:

  ALTER TABLE contracts 
  ALTER COLUMN affiliate_id DROP NOT NULL;

===============================================================================
  Ø§Ù„Ø­Ù„ Ø§Ù„Ø³Ø±ÙŠØ¹ - Ù„Ù„Ø§Ø®ØªØ¨Ø§Ø± Ø§Ù„ÙÙˆØ±ÙŠ
===============================================================================

Ø¥Ø°Ø§ ÙƒÙ†Øª ØªØ±ÙŠØ¯ Ø§Ø®ØªØ¨Ø§Ø± ÙÙˆØ±Ø§Ù‹:

Ø§Ù„Ø®Ø·ÙˆØ© 1: Ø§Ø­ØµÙ„ Ø¹Ù„Ù‰ user_id
â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  SELECT id, email FROM auth.users 
  WHERE email = 'YOUR_AFFILIATE_EMAIL';

Ø§Ù„Ø®Ø·ÙˆØ© 2: ØªØ­Ù‚Ù‚ Ù…Ù† affiliate
â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  SELECT * FROM affiliates WHERE user_id = 'USER_ID_FROM_STEP_1';

Ø§Ù„Ø®Ø·ÙˆØ© 3: Ø¥Ø°Ø§ Ù„Ù… ÙŠÙˆØ¬Ø¯ØŒ Ø£Ù†Ø´Ø¦Ù‡
â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  INSERT INTO affiliates (user_id, name, email, status)
  VALUES (
    'USER_ID_FROM_STEP_1',
    'Test Affiliate',
    'YOUR_AFFILIATE_EMAIL',
    'active'
  )
  RETURNING id;

Ø§Ù„Ø®Ø·ÙˆØ© 4: Ø¬Ø±Ø¨ Ø¥Ù†Ø´Ø§Ø¡ Ø§Ù„Ø¹Ù‚Ø¯ Ù…Ø±Ø© Ø£Ø®Ø±Ù‰
â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  ÙŠØ¬Ø¨ Ø£Ù† ÙŠØ¹Ù…Ù„ Ø§Ù„Ø¢Ù† âœ“

===============================================================================
  Ø§Ù„ÙˆÙ‚Ø§ÙŠØ© Ù…Ù† Ø§Ù„Ù…Ø´ÙƒÙ„Ø© Ù…Ø³ØªÙ‚Ø¨Ù„Ø§Ù‹
===============================================================================

Ø§Ù„Ø­Ù„ 1: Trigger ØªÙ„Ù‚Ø§Ø¦ÙŠ
â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€

Ø£Ù†Ø´Ø¦ trigger ÙŠÙÙ†Ø´Ø¦ affiliate ØªÙ„Ù‚Ø§Ø¦ÙŠØ§Ù‹ Ø¹Ù†Ø¯ ØªØ³Ø¬ÙŠÙ„ Ù…Ø³ØªØ®Ø¯Ù… Ø¬Ø¯ÙŠØ¯:

  CREATE OR REPLACE FUNCTION create_affiliate_on_signup()
  RETURNS TRIGGER AS $$
  BEGIN
    -- Ø¥Ø°Ø§ ÙƒØ§Ù† Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù… Ù…Ù† Ù†ÙˆØ¹ affiliate
    IF NEW.raw_user_meta_data->>'role' = 'affiliate' THEN
      INSERT INTO affiliates (user_id, email, name, status)
      VALUES (
        NEW.id,
        NEW.email,
        COALESCE(NEW.raw_user_meta_data->>'name', 'New Affiliate'),
        'pending'
      );
    END IF;
    RETURN NEW;
  END;
  $$ LANGUAGE plpgsql SECURITY DEFINER;

  CREATE TRIGGER on_auth_user_created_affiliate
    AFTER INSERT ON auth.users
    FOR EACH ROW
    EXECUTE FUNCTION create_affiliate_on_signup();

â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€

Ø§Ù„Ø­Ù„ 2: Validation ÙÙŠ Ø§Ù„ÙƒÙˆØ¯
â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€

ÙÙŠ app/affiliate/contracts/new/page.tsx:

  // Get affiliate info
  const { data: affiliate, error } = await supabase
    .from("affiliates")
    .select("*")
    .eq("user_id", user.id)
    .single()

  if (!affiliate) {
    // Ø¨Ø¯Ù„Ø§Ù‹ Ù…Ù† redirectØŒ Ø£Ù†Ø´Ø¦ affiliate
    const { data: newAffiliate } = await supabase
      .from("affiliates")
      .insert({
        user_id: user.id,
        name: user.user_metadata?.name || user.email,
        email: user.email,
        status: 'active'
      })
      .select()
      .single()
    
    if (!newAffiliate) {
      redirect("/")
    }
    
    // Ø§Ø³ØªØ®Ø¯Ù… Ø§Ù„Ù€ affiliate Ø§Ù„Ø¬Ø¯ÙŠØ¯
    affiliate = newAffiliate
  }

===============================================================================
  Ø§Ù„Ù…Ù„ÙØ§Øª Ø§Ù„Ù…Ø³Ø§Ø¹Ø¯Ø©
===============================================================================

ØªÙ… Ø¥Ù†Ø´Ø§Ø¡:
  âœ“ database/migrations/fix_affiliate_foreign_key.sql
    - SQL ÙƒØ§Ù…Ù„ Ù„Ù„ØªØ´Ø®ÙŠØµ ÙˆØ§Ù„Ø¥ØµÙ„Ø§Ø­
    - ÙŠÙ…ÙƒÙ† ØªØ´ØºÙŠÙ„Ù‡ Ù…Ø¨Ø§Ø´Ø±Ø© ÙÙŠ Supabase

===============================================================================
  Ø§Ù„Ø®Ù„Ø§ØµØ©
===============================================================================

Ø§Ù„Ù…Ø´ÙƒÙ„Ø©: affiliate_id Ø§Ù„Ù…ÙØ±Ø³Ù„ ØºÙŠØ± Ù…ÙˆØ¬ÙˆØ¯ ÙÙŠ Ø¬Ø¯ÙˆÙ„ affiliates

Ø§Ù„Ø­Ù„ Ø§Ù„Ø£Ø³Ø±Ø¹:
  1. ØªØ­Ù‚Ù‚ Ù…Ù† ÙˆØ¬ÙˆØ¯ Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù… ÙÙŠ affiliates
  2. Ø¥Ø°Ø§ Ù„Ù… ÙŠÙˆØ¬Ø¯ØŒ Ø£Ù†Ø´Ø¦ Ø³Ø¬Ù„ Ù„Ù‡
  3. Ø¬Ø±Ø¨ Ø¥Ù†Ø´Ø§Ø¡ Ø§Ù„Ø¹Ù‚Ø¯ Ù…Ø±Ø© Ø£Ø®Ø±Ù‰

Ø§Ù„Ø­Ù„ Ø§Ù„Ø¯Ø§Ø¦Ù…:
  1. Ø£Ø¶Ù trigger Ù„Ø¥Ù†Ø´Ø§Ø¡ affiliate ØªÙ„Ù‚Ø§Ø¦ÙŠØ§Ù‹
  2. Ø£Ùˆ Ø£Ø¶Ù validation ÙÙŠ Ø§Ù„ÙƒÙˆØ¯
  3. Ø£Ùˆ Ø§Ø¬Ø¹Ù„ affiliate_id nullable

===============================================================================
